# PHPUnit Test Report Formats Guide

## Overview

The Gravitycar Framework test suite generates multiple report formats to support different CI/CD systems and debugging needs. This document explains the available formats and how to configure them.

## Current Issue

The GitHub Actions CI/CD pipeline was failing with the error:
```
Error: Processing test results from phpunit-report.xml failed
Error: Error: Invalid XML at phpunit-report.xml
Error: Unexpected close tag
Line: 1306
Column: 13
Char: >
```

This occurred because the XML consolidation process was manually merging multiple JUnit XML files with basic text processing, which could break XML structure.

## Available Report Formats

### 1. JUnit XML (Default)
- **File**: `phpunit-report.xml`
- **Used by**: GitHub Actions `dorny/test-reporter` with `java-junit` reporter
- **Advantages**: Most widely supported format, works with most CI/CD systems
- **Disadvantages**: XML parsing can be fragile when consolidating multiple files

### 2. JSON Report (Backup)
- **File**: `phpunit-report.json`
- **Generated by**: `scripts/test/convert-junit-to-json.php`
- **Advantages**: More robust structure, easier to parse programmatically
- **Disadvantages**: Requires custom processing in GitHub Actions

### 3. Individual JUnit Files
- **Files**: `coverage/junit-unit.xml`, `coverage/junit-integration.xml`, `coverage/junit-feature.xml`
- **Generated by**: PHPUnit test suite runs
- **Advantages**: No consolidation issues, clean XML structure
- **Disadvantages**: GitHub Actions expects single file

## Solutions Implemented

### 1. Improved XML Consolidation (Primary Fix)

Updated `scripts/test/test-backend.sh` with:
- Better XML parsing using `sed` with proper regex patterns
- XML validation using `xmllint` when available
- Fallback to first valid JUnit file if consolidation fails
- Proper calculation of test result totals

### 2. JSON Format Generation (Backup)

Created `scripts/test/convert-junit-to-json.php` to:
- Parse multiple JUnit XML files using PHP's `SimpleXML`
- Generate a consolidated JSON report with test results
- Provide comprehensive error handling and validation

## GitHub Actions Configuration Options

### Option 1: Current JUnit XML (Recommended)
```yaml
- name: Publish test results
  uses: dorny/test-reporter@v1
  if: always()
  with:
    name: PHPUnit Tests
    path: phpunit-report.xml
    reporter: java-junit
    fail-on-error: true
```

### Option 2: Use Individual Files
```yaml
- name: Publish test results
  uses: dorny/test-reporter@v1
  if: always()
  with:
    name: PHPUnit Tests
    path: coverage/junit-*.xml
    reporter: java-junit
    fail-on-error: true
```

### Option 3: Custom JSON Processing
```yaml
- name: Process JSON test results
  run: |
    if [ -f "phpunit-report.json" ]; then
      echo "JSON test report available for custom processing"
      # Add custom logic to process JSON and create GitHub check annotations
    fi
```

## Switching Report Formats

### To Use Individual JUnit Files Instead of Consolidated
1. Update `.github/workflows/deploy.yml`:
   ```yaml
   path: coverage/junit-*.xml  # Instead of phpunit-report.xml
   ```

### To Generate Only JSON Reports
1. Modify `scripts/test/test-backend.sh` to skip XML consolidation
2. Update GitHub workflow to process JSON instead of XML

### To Add HTML Reports for Local Debugging
PHPUnit already generates:
- `coverage/testdox.html` - Human-readable test documentation
- `coverage/testdox-unit.html`, etc. - Per-suite documentation

## Testing the Fix

### Local Testing
```bash
# Run tests and generate reports
./scripts/test/run-tests.sh --mode=ci --coverage=true

# Validate XML output
xmllint --noout phpunit-report.xml && echo "XML is valid"

# Check JSON output
if [ -f "phpunit-report.json" ]; then
  jq . phpunit-report.json >/dev/null && echo "JSON is valid"
fi
```

### CI/CD Testing
The improved XML consolidation should resolve the GitHub Actions parsing errors. If issues persist:

1. Check the GitHub Actions logs for specific error details
2. Download the generated `phpunit-report.xml` artifact to inspect manually
3. Consider switching to individual files approach as fallback

## Monitoring and Maintenance

### XML Validation
The script now includes automatic XML validation when `xmllint` is available. This helps catch malformed XML before it reaches GitHub Actions.

### Error Handling
- Graceful fallback to individual files if consolidation fails
- Comprehensive logging for debugging issues
- JSON backup format for alternative processing

### Future Improvements
- Consider using a proper XML library for consolidation instead of text processing
- Add support for other test result formats (TAP, Mocha, etc.)
- Implement test result caching for faster CI/CD pipelines

## Related Files

- `.github/workflows/deploy.yml` - GitHub Actions workflow configuration
- `scripts/test/test-backend.sh` - Test execution and report generation
- `scripts/test/convert-junit-to-json.php` - JSON format converter
- `phpunit.xml` - PHPUnit configuration
- `coverage/` - Directory containing all test reports and coverage data