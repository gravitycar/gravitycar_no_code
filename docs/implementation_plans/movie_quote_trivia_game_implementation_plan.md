# Movie Quote Trivia Game Implementation Plan

## 1. Feature Overview

The Movie Quote Trivia Game is an interactive web-based trivia game where users are shown 15 movie quotes and must identify which of 3 movies each quote is from. The game implements a sophisticated scoring system based on correctness, time taken, and movie obscurity. Each game session creates persistent records of the gameplay and questions for auditing and high score tracking.

### Key Components:
- **Movie_Quote_Trivia_Games Model**: Tracks individual game sessions with final scores
- **Movie_Quote_Trivia_Questions Model**: Manages individual trivia questions with correct/incorrect answers 
- **Game Interface**: Custom React component for interactive gameplay (separate from GenericCrudPage)
- **High Scores Page**: Leaderboard showing top 10 game scores
- **Backend Game Engine**: Server-side logic for question generation and scoring

## 2. Requirements Analysis

### Functional Requirements:
1. **Game Session Management**
   - Create new game sessions with 15 auto-generated questions
   - Track real-time scoring with time penalties
   - Save final game results with user attribution
   - Generate unique game names based on user and date

2. **Question Generation System**
   - Use Movie_Quote_Trivia_Questions class to create 15 unique trivia questions
   - Movie_Quote_Trivia_Questions auto-generates correct answer and two distractor movies
   - Ensure no duplicate quotes within a single game session (enforced by Movie_Quote_Trivia_Games)
   - Calculate and apply obscurity-based bonus scoring from movie metadata

3. **Interactive Game Interface**
   - Real-time score display with color-coded feedback
   - Sequential question presentation (one at a time)
   - Visual feedback for correct/incorrect answers
   - Smooth animations for answered questions
   - Movie poster display for answer options

4. **High Score Tracking**
   - Persistent storage of completed games
   - Leaderboard with top 10 scores
   - User identification and game date tracking

### Non-Functional Requirements:
- **Performance**: Game must be responsive with <200ms answer feedback
- **Usability**: Intuitive interface suitable for casual gaming
- **Scalability**: Support for concurrent users playing simultaneously
- **Data Integrity**: Consistent question generation and scoring (no duplicate quotes per game)
- **Touch Optimization**: Responsive design optimized for mobile touch interfaces

## 3. Design

### 3.1 Database Schema Design

**⚠️ IMPORTANT NOTE:** The SQL CREATE TABLE statements below are provided for **REFERENCE ONLY** and should **NEVER be executed directly**. All database tables and schema are automatically generated by the Gravitycar Framework's SchemaGenerator, which reads the model metadata files and creates the appropriate database structure. The SQL statements below represent the intended schema that the metadata should generate.

## ⚠️ CRITICAL METADATA DISCREPANCIES IDENTIFIED

After examining the existing `Movie_Quote_Trivia_Questions` metadata, there are **significant discrepancies** between the current implementation and the proposed game schema:

### Existing Movie_Quote_Trivia_Questions Metadata vs. Proposed Schema:

**MISSING CRITICAL FIELDS (specified for addition):**
- ✅ `game_id` - Links questions to game sessions (UUID, nullable, readOnly)
- ✅ `question_order` - Sequence tracking 1-15 (Integer, nullable, readOnly)  
- ✅ `user_selected_option` - Player answer recording (Integer 1-3, nullable)
- ✅ `answered_at` - Answer timestamp (DateTime, nullable)
- ✅ `time_taken_seconds` - Timing for scoring (Integer, nullable, min:0)

**FIELD COMPATIBILITY CONFIRMED:**
- ✅ `answer_option_1/2/3` (existing) - Movie IDs for answer choices  
- ✅ `correct_answer` (existing) - Movie ID of correct answer (not option number)
- ✅ `answered_correctly` (existing) - Boolean validation result
- ✅ `obscurity_score` (existing) - Integer bonus scoring support

**ARCHITECTURAL DIFFERENCE:**
- Existing metadata is designed for **standalone trivia questions**
- Proposed schema extends this for **game session management** with backward compatibility

### Required Actions:
1. **Update Movie_Quote_Trivia_Questions metadata** to include game session fields
2. **Create Movie_Quote_Trivia_Games metadata** (completely new)
3. **Verify field naming consistency** between SQL schema and metadata
4. **Update relationships** to support game-to-questions association

#### Movie_Quote_Trivia_Games Table
```sql
CREATE TABLE movie_quote_trivia_games (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    score INT NOT NULL DEFAULT 100,
    game_started_at DATETIME NOT NULL,
    game_completed_at DATETIME NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    created_by VARCHAR(36), -- Player identity (NULL for guest users)
    updated_by VARCHAR(36),
    deleted_at DATETIME NULL,
    deleted_by VARCHAR(36),
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_score_desc (score DESC),
    INDEX idx_player_games (created_by, created_at),
    INDEX idx_completed_games (game_completed_at)
);
```

#### Movie_Quote_Trivia_Questions Table (CORRECTED FIELD NAMES)
```sql
CREATE TABLE movie_quote_trivia_questions (
    id VARCHAR(36) PRIMARY KEY,
    game_id VARCHAR(36) NULL, -- Allow standalone questions, nullable for backward compatibility
    movie_quote_id VARCHAR(36) NOT NULL,
    answer_option_1 VARCHAR(36) NOT NULL, -- Movie ID for option 1
    answer_option_2 VARCHAR(36) NOT NULL, -- Movie ID for option 2
    answer_option_3 VARCHAR(36) NOT NULL, -- Movie ID for option 3
    correct_answer VARCHAR(36) NOT NULL, -- Movie ID of correct answer (not option number)
    user_selected_option INT NULL, -- 1, 2, or 3, NULL if unanswered
    answered_correctly BOOLEAN NULL, -- NULL if unanswered
    question_order INT NULL, -- 1-15, NULL for standalone questions
    answered_at DATETIME NULL,
    time_taken_seconds INT NULL,
    obscurity_score INT NULL, -- Added from existing metadata
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    created_by VARCHAR(36),
    updated_by VARCHAR(36),
    FOREIGN KEY (game_id) REFERENCES movie_quote_trivia_games(id) ON DELETE CASCADE,
    FOREIGN KEY (movie_quote_id) REFERENCES movie_quotes(id),
    FOREIGN KEY (answer_option_1) REFERENCES movies(id),
    FOREIGN KEY (answer_option_2) REFERENCES movies(id),
    FOREIGN KEY (answer_option_3) REFERENCES movies(id),
    FOREIGN KEY (correct_answer) REFERENCES movies(id), -- Added constraint for correct answer
    INDEX idx_game_order (game_id, question_order),
    INDEX idx_quote_usage (movie_quote_id)
);
```

#### Relationship Tables
```sql
-- Game to Questions (One-to-Many) - Generated automatically by SchemaGenerator
-- Table name follows Gravitycar naming convention: rel_1_<modelOne>_M_<modelMany>
CREATE TABLE rel_1_movie_quote_trivia_games_M_movie_quote_trivia_questions (
    id VARCHAR(36) PRIMARY KEY,
    one_movie_quote_trivia_games_id VARCHAR(36) NOT NULL,
    many_movie_quote_trivia_questions_id VARCHAR(36) NOT NULL,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (one_movie_quote_trivia_games_id) REFERENCES movie_quote_trivia_games(id) ON DELETE CASCADE,
    FOREIGN KEY (many_movie_quote_trivia_questions_id) REFERENCES movie_quote_trivia_questions(id) ON DELETE CASCADE,
    UNIQUE KEY unique_game_question (one_movie_quote_trivia_games_id, many_movie_quote_trivia_questions_id)
);
```

**Note**: The above relationship table WILL be necessary and will be automatically created by the Gravitycar Framework's SchemaGenerator based on the relationship metadata. The SchemaGenerator creates relationship tables for all OneToMany and ManyToMany relationships defined in the metadata, regardless of whether direct foreign key fields exist in the model tables.

### 3.2 Backend Architecture

#### Movie Quote Selection Feature
The Movie_Quote_Trivia_Questions class provides comprehensive functionality for trivia question generation:

- **Auto-Generated Questions**: When created, automatically selects a random movie quote and generates answer options
- **Distractor Generation**: Automatically selects 2 random movies as incorrect options (distractors) 
- **Randomized Layout**: Shuffles the correct answer and distractors among the 3 option positions
- **Answer Validation**: Built-in `validateAnswer()` method to check if user's selection is correct
- **Obscurity Integration**: Automatically populates obscurity score from the related movie
- **Performance Optimization**: Cached movie model retrievals and efficient database queries

The Movie_Quote_Trivia_Games class is responsible for:
- **Duplicate Prevention**: Ensuring no repeated quotes within a single game session
- **Game Orchestration**: Managing the collection of 15 unique questions per game
- **Scoring Logic**: Applying time penalties, answer bonuses, and obscurity bonuses
- **Player Identity**: Using core `created_by` field to track game ownership (NULL for guest users, User ID for authenticated users)

#### Movie_Quote_Trivia_Games Model Metadata
```php
// src/Models/movie_quote_trivia_games/movie_quote_trivia_games_metadata.php
return [
    'name' => 'Movie_Quote_Trivia_Games',
    'table' => 'movie_quote_trivia_games',
    'displayColumns' => ['name', 'score', 'game_completed_at'],
    'fields' => [
        'name' => [
            'name' => 'name',
            'type' => 'Text',
            'label' => 'Game Name',
            'required' => true,
            'maxLength' => 255,
            'readOnly' => true, // Auto-generated: "User Name's game played on Date" or "Guest game Date/Time"
            'validationRules' => ['Required'],
        ],
        'score' => [
            'name' => 'score',
            'type' => 'Integer',
            'label' => 'Final Score',
            'required' => true,
            'minValue' => 0,
            'defaultValue' => 100,
            'readOnly' => true,
            'validationRules' => ['Required'],
        ],
        'game_started_at' => [
            'name' => 'game_started_at',
            'type' => 'DateTime',
            'label' => 'Game Started',
            'required' => true,
            'readOnly' => true,
            'validationRules' => ['Required', 'DateTime'],
        ],
        'game_completed_at' => [
            'name' => 'game_completed_at',
            'type' => 'DateTime',
            'label' => 'Game Completed',
            'required' => false,
            'readOnly' => true,
            'nullable' => true,
            'validationRules' => ['DateTime'],
        ],
    ],
    'relationships' => [
        'movie_quote_trivia_games_movie_quote_trivia_questions', // Reference to relationship metadata file
    ],
    'ui' => [
        'listFields' => ['name', 'score', 'created_by_name', 'game_completed_at'],
        'createFields' => [], // Games created via special endpoint
        'editFields' => [], // Games are read-only after creation
    ],
];
```

#### Game-to-Questions Relationship Metadata
```php
// src/Relationships/movie_quote_trivia_games_movie_quote_trivia_questions/movie_quote_trivia_games_movie_quote_trivia_questions_metadata.php
<?php
return [
    'name' => 'movie_quote_trivia_games_movie_quote_trivia_questions',
    'type' => 'OneToMany',
    'modelOne' => 'Movie_Quote_Trivia_Games',
    'modelMany' => 'Movie_Quote_Trivia_Questions',
    'constraints' => [],
    'additionalFields' => [],
];
```

#### Movie_Quote_Trivia_Questions Model Metadata (UPDATED WITH GAME SESSION FIELDS)
```php
// src/Models/movie_quote_trivia_questions/movie_quote_trivia_questions_metadata.php
// UPDATED to include game session support while preserving existing functionality
return [
    'name' => 'Movie_Quote_Trivia_Questions',
    'table' => 'movie_quote_trivia_questions',
    'displayColumns' => ['movie_quote_display', 'answered_correctly', 'question_order'],
    'fields' => [
        // EXISTING FIELDS (preserve as-is)
        'movie_quote_id' => [
            'name' => 'movie_quote_id',
            'type' => 'RelatedRecord',
            'label' => 'Movie Quote',
            'required' => true,
            'relatedModel' => 'Movie_Quotes',
            'relatedFieldName' => 'id',
            'displayFieldName' => 'movie_quote_display',
            'description' => 'The movie quote this trivia question is based on',
            'validationRules' => ['Required'],
        ],
        'movie_quote_display' => [
            'name' => 'movie_quote_display',
            'type' => 'Text',
            'label' => 'Movie Quote Text',
            'readOnly' => true,
            'isDBField' => false,
            'description' => 'Display text for the movie quote',
            'validationRules' => [],
        ],
        'answers' => [
            'name' => 'answers',
            'type' => 'RadioButtonSet',
            'label' => 'Answer Options',
            'required' => false,
            'nullable' => true,
            'layout' => 'vertical',
            'allowClear' => false,
            'optionsClass' => 'Gravitycar\\Models\\movie_quote_trivia_questions\\Movie_Quote_Trivia_Questions',
            'optionsMethod' => 'getAnswerOptionsForField',
            'description' => 'Three movie title options - select the correct one',
            'validationRules' => [],
        ],
        'correct_answer' => [
            'name' => 'correct_answer',
            'type' => 'ID',
            'label' => 'Correct Answer',
            'readOnly' => true,
            'isDBField' => true,
            'required' => true,
            'description' => 'ID of the correct movie (hidden from UI)',
            'validationRules' => ['Required'],
        ],
        'answer_option_1' => [
            'name' => 'answer_option_1',
            'type' => 'ID',
            'label' => 'Answer Option 1',
            'readOnly' => true,
            'isDBField' => true,
            'required' => true,
            'description' => 'First movie option (hidden from UI)',
            'validationRules' => ['Required'],
        ],
        'answer_option_2' => [
            'name' => 'answer_option_2',
            'type' => 'ID',
            'label' => 'Answer Option 2',
            'readOnly' => true,
            'isDBField' => true,
            'required' => true,
            'description' => 'Second movie option (hidden from UI)',
            'validationRules' => ['Required'],
        ],
        'answer_option_3' => [
            'name' => 'answer_option_3',
            'type' => 'ID',
            'label' => 'Answer Option 3',
            'readOnly' => true,
            'isDBField' => true,
            'required' => true,
            'description' => 'Third movie option (hidden from UI)',
            'validationRules' => ['Required'],
        ],
        'answered_correctly' => [
            'name' => 'answered_correctly',
            'type' => 'Boolean',
            'label' => 'Answered Correctly',
            'required' => false,
            'defaultValue' => false,
            'description' => 'Whether this question was answered correctly',
            'validationRules' => [],
        ],
        'obscurity_score' => [
            'name' => 'obscurity_score',
            'type' => 'Integer',
            'label' => 'Obscurity Score',
            'minValue' => 1,
            'maxValue' => 5,
            'readOnly' => true,
            'nullable' => true,
            'description' => 'Film obscurity: 1=Very Popular, 5=Very Obscure',
            'validationRules' => [],
        ],
        
        // NEW GAME SESSION FIELDS (added for trivia game support)
        'game_id' => [
            'name' => 'game_id',
            'type' => 'UUID',
            'label' => 'Game Session',
            'required' => false, // Allow standalone questions and game-linked questions
            'nullable' => true,
            'readOnly' => true,
            'description' => 'Links question to specific game session (null for standalone questions)',
            'validationRules' => [],
        ],
        'question_order' => [
            'name' => 'question_order',
            'type' => 'Integer',
            'label' => 'Question Order',
            'required' => false,
            'minValue' => 1,
            'maxValue' => 15,
            'nullable' => true,
            'readOnly' => true,
            'description' => 'Question sequence within game (1-15, null for standalone)',
            'validationRules' => [],
        ],
        'user_selected_option' => [
            'name' => 'user_selected_option',
            'type' => 'Integer',
            'label' => 'User Selected Option',
            'required' => false,
            'minValue' => 1,
            'maxValue' => 3,
            'nullable' => true,
            'description' => 'Which option player selected (1, 2, or 3)',
            'validationRules' => [],
        ],
        'answered_at' => [
            'name' => 'answered_at',
            'type' => 'DateTime',
            'label' => 'Answered At',
            'required' => false,
            'nullable' => true,
            'description' => 'Timestamp when question was answered',
            'validationRules' => ['DateTime'],
        ],
        'time_taken_seconds' => [
            'name' => 'time_taken_seconds',
            'type' => 'Integer',
            'label' => 'Time Taken (Seconds)',
            'required' => false,
            'minValue' => 0,
            'nullable' => true,
            'description' => 'Seconds taken to answer question (for scoring)',
            'validationRules' => [],
        ],
    ],
    'validationRules' => [],
    'relationships' => [], // Updated: No complex relationship definitions needed - field-level references sufficient
    'ui' => [
        // UPDATED to include new game session fields
        'listFields' => [
            'movie_quote_display', 
            'answered_correctly', 
            'obscurity_score',
            'question_order',           // NEW
            'user_selected_option',     // NEW
            'time_taken_seconds'        // NEW
        ],
        'createFields' => ['movie_quote_id', 'answers'], // Keep existing - standalone questions
        'editFields' => [
            'movie_quote_id', 
            'answers', 
            'answered_correctly',
            'user_selected_option'      // NEW - allow updating answer selection
        ],
    ],
];
```

### 3.3 API Endpoints Design

#### Game Management Endpoints
```php
// Custom API routes for trivia game
'apiRoutes' => [
    // Standard CRUD for admin/debugging
    ['method' => 'GET', 'path' => '/Movie_Quote_Trivia_Games', 'apiClass' => 'TriviaGameAPIController', 'apiMethod' => 'index'],
    ['method' => 'GET', 'path' => '/Movie_Quote_Trivia_Games/?', 'apiClass' => 'TriviaGameAPIController', 'apiMethod' => 'read'],
    ['method' => 'DELETE', 'path' => '/Movie_Quote_Trivia_Games/?', 'apiClass' => 'TriviaGameAPIController', 'apiMethod' => 'delete'],
    
    // Game-specific endpoints (support both authenticated and guest users)
    ['method' => 'POST', 'path' => '/trivia/start-game', 'apiClass' => 'TriviaGameAPIController', 'apiMethod' => 'startGame'],
    ['method' => 'GET', 'path' => '/trivia/game/?', 'apiClass' => 'TriviaGameAPIController', 'apiMethod' => 'getGameWithQuestions'],
    ['method' => 'PUT', 'path' => '/trivia/answer', 'apiClass' => 'TriviaGameAPIController', 'apiMethod' => 'submitAnswer'],
    ['method' => 'PUT', 'path' => '/trivia/complete-game/?', 'apiClass' => 'TriviaGameAPIController', 'apiMethod' => 'completeGame'],
    ['method' => 'GET', 'path' => '/trivia/high-scores', 'apiClass' => 'TriviaGameAPIController', 'apiMethod' => 'getHighScores'],
]
```

### 3.4 Frontend Architecture

#### React Component Structure
```
src/components/trivia/
├── TriviaGamePage.tsx          # Main game interface
├── TriviaGameBoard.tsx         # Game board with questions
├── TriviaQuestion.tsx          # Individual question component  
├── TriviaScoreDisplay.tsx      # Real-time score display
├── TriviaAnswerOption.tsx      # Movie option with poster
├── TriviaGameComplete.tsx      # End game screen
├── TriviaHighScores.tsx        # High scores page
└── TriviaGameHistory.tsx       # User's game history
```

#### Navigation Integration
```typescript
// src/App.tsx - Add new routes (accessible to both authenticated and guest users)
<Route path="/trivia" element={
  <Layout>
    <TriviaGamePage />
  </Layout>
} />

<Route path="/trivia/high-scores" element={
  <Layout>
    <TriviaHighScores />
  </Layout>
} />

{/* Admin-only route for game management */}
<Route path="/trivia-games" element={
  <ProtectedRoute>
    <Layout>
      <GenericCrudPage modelName="Movie_Quote_Trivia_Games" title="Trivia Games" />
    </Layout>
  </ProtectedRoute>
} />
```

#### Layout Navigation Updates
```typescript
// src/components/layout/Layout.tsx - Add navigation links
<a href="/trivia" className="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
  🎮 Play Trivia
</a>
<a href="/trivia/high-scores" className="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
  🏆 High Scores
</a>
<a href="/trivia-games" className="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
  📊 Game History
</a>
```

## 4. Implementation Steps

### Phase 1: Backend Models and Database (Days 1-2)

**⚠️ CRITICAL FIRST STEP: Metadata Migration**
The existing `Movie_Quote_Trivia_Questions` metadata must be updated to support game sessions before proceeding.

1. **Update Existing Movie_Quote_Trivia_Questions Metadata**
   - [ ] **BACKUP existing metadata file** before making changes
   - [ ] Add the following 5 game session fields to existing `movie_quote_trivia_questions_metadata.php`:

```php
// ADD THESE FIELDS TO EXISTING METADATA (after 'obscurity_score' field):

'game_id' => [
    'name' => 'game_id',
    'type' => 'UUID',
    'label' => 'Game Session',
    'required' => false, // Allow standalone questions and game-linked questions
    'nullable' => true,
    'readOnly' => true,
    'description' => 'Links question to specific game session (null for standalone questions)',
    'validationRules' => [],
],
'question_order' => [
    'name' => 'question_order',
    'type' => 'Integer',
    'label' => 'Question Order',
    'required' => false,
    'minValue' => 1,
    'maxValue' => 15,
    'nullable' => true,
    'readOnly' => true,
    'description' => 'Question sequence within game (1-15, null for standalone)',
    'validationRules' => [],
],
'user_selected_option' => [
    'name' => 'user_selected_option',
    'type' => 'Integer',
    'label' => 'User Selected Option',
    'required' => false,
    'minValue' => 1,
    'maxValue' => 3,
    'nullable' => true,
    'description' => 'Which option player selected (1, 2, or 3)',
    'validationRules' => [],
],
'answered_at' => [
    'name' => 'answered_at',
    'type' => 'DateTime',
    'label' => 'Answered At',
    'required' => false,
    'nullable' => true,
    'description' => 'Timestamp when question was answered',
    'validationRules' => ['DateTime'],
],
'time_taken_seconds' => [
    'name' => 'time_taken_seconds',
    'type' => 'Integer',
    'label' => 'Time Taken (Seconds)',
    'required' => false,
    'minValue' => 0,
    'nullable' => true,
    'description' => 'Seconds taken to answer question (for scoring)',
    'validationRules' => [],
],
```

   - [ ] **UPDATE the 'ui' section** to include new fields in appropriate lists:
     - Add `question_order`, `user_selected_option`, `time_taken_seconds` to `listFields`
     - Keep `createFields` and `editFields` as-is (game questions auto-created)
   - [ ] **PRESERVE all existing fields** - do not modify existing structure
   - [ ] **VERIFY field compatibility** with existing `Movie_Quote_Trivia_Questions` class methods

2. **Create Model Metadata Files**
   - [ ] Create `src/Models/movie_quote_trivia_games/movie_quote_trivia_games_metadata.php`
   - [ ] **DO NOT create new movie_quote_trivia_questions_metadata.php** - update existing one instead
   - [ ] Create relationship metadata: `src/Relationships/movie_quote_trivia_games_movie_quote_trivia_questions/movie_quote_trivia_games_movie_quote_trivia_questions_metadata.php`
   - [ ] Update Movie_Quote_Trivia_Games metadata to reference the relationship
   - [ ] Define all fields, relationships, and validation rules

2. **Create Model Classes**
   - [ ] Create `src/Models/movie_quote_trivia_games/Movie_Quote_Trivia_Games.php`
   - [ ] Create `src/Models/movie_quote_trivia_questions/Movie_Quote_Trivia_Questions.php`
   - [ ] Implement business logic methods (game name generation, scoring)
   - [ ] Implement Movie_Quote_Trivia_Question random selection feature

3. **Database Schema Generation**
   - [ ] Run `php setup.php` to create tables and relationship tables
   - [ ] Verify schema matches design specifications
   - [ ] Test basic CRUD operations

### Phase 2: Game Engine Backend Logic (Days 3-4)
1. **Create TriviaGameAPIController**
   - [ ] Create `src/Api/TriviaGameAPIController.php`
   - [ ] Implement `startGame()` method utilizing Movie_Quote_Trivia_Questions auto-generation
   - [ ] Implement `getGameWithQuestions()` for game state retrieval
   - [ ] Implement `submitAnswer()` using built-in `validateAnswer()` method
   - [ ] Leverage existing Movie_Quote_Trivia_Questions features for question creation

2. **Game Orchestration Logic**
   - [ ] Create method to generate 15 unique Movie_Quote_Trivia_Question instances (auto-generating content)
   - [ ] Leverage existing Movie_Quote_Trivia_Questions class features:
     - Automatic random quote selection
     - Automatic distractor generation (2 incorrect movies)
     - Automatic answer shuffling across 3 positions
     - Built-in obscurity score integration
   - [ ] Add validation to prevent duplicate quotes in single game session
   - [ ] Implement game completion and scoring aggregation

3. **Scoring System**
   - [ ] Implement time-based score reduction (1 point per second)
   - [ ] Implement wrong answer penalty (-3 points)
   - [ ] Implement correct answer bonus (+3 + obscurity_score)
   - [ ] Ensure score never goes below 0

### Phase 3: Frontend Game Interface (Days 5-7)
1. **Create Core Game Components**
   - [ ] Create `TriviaGamePage.tsx` with game state management (guest and authenticated users)
   - [ ] Create `TriviaQuestion.tsx` with movie poster display
   - [ ] Create `TriviaScoreDisplay.tsx` with real-time updates
   - [ ] Create `TriviaAnswerOption.tsx` with movie info and touch-optimized radio buttons (48px touch targets)

2. **Implement Game Flow**
   - [ ] Implement sequential question display (one at a time, no pause/resume)
   - [ ] Add answer submission and feedback logic
   - [ ] Implement "shrink" animation for answered questions
   - [ ] Add visual feedback (green/red borders, "Right!"/"Wrong!" flash)
   - [ ] Optimize touch interactions for mobile devices

3. **Game State Management**
   - [ ] Create React hooks for game state (`useGameState`)
   - [ ] Implement real-time score tracking
   - [ ] Add timer functionality for time penalties
   - [ ] Handle game completion and final score submission
   - [ ] Support both guest and authenticated user sessions

### Phase 4: High Scores and Navigation (Days 8-9)
1. **High Scores Page**
   - [ ] Create `TriviaHighScores.tsx` component
   - [ ] Implement API call to fetch top 10 scores (limit enforced)
   - [ ] Display leaderboard with player names (or "Guest Player") and scores
   - [ ] Add filtering/sorting options
   - [ ] Handle display of both authenticated and guest scores
   - [ ] Treat guest and authenticated user scores equally in rankings

2. **Navigation Integration**
   - [ ] Add trivia game links to main navigation (accessible to all users)
   - [ ] Update `App.tsx` with new routes (public routes for trivia)
   - [ ] Add game links to Dashboard quick actions
   - [ ] Ensure GenericCrudPage works for admin game management
   - [ ] Add guest-friendly navigation options

3. **Game History**
   - [ ] Create user's personal game history view (authenticated users only)
   - [ ] Show past games with scores and completion dates
   - [ ] Add ability to view detailed question results
   - [ ] Provide login prompt for guest users wanting to save history

### Phase 5: Testing and Polish (Days 10-11)
1. **Backend Testing**
   - [ ] Unit tests for question generation algorithm
   - [ ] Unit tests for scoring system
   - [ ] Integration tests for API endpoints
   - [ ] Performance testing for concurrent games

2. **Frontend Testing**
   - [ ] Component unit tests
   - [ ] Game flow integration tests
   - [ ] User experience testing (authenticated and guest users)
   - [ ] Cross-browser compatibility testing
   - [ ] Mobile touch interface testing

3. **Bug Fixes and Polish**
   - [ ] Fix any issues found during testing
   - [ ] Optimize performance and responsiveness
   - [ ] Improve touch interface usability
   - [ ] Add loading states and error handling
   - [ ] Ensure guest and authenticated user flows work seamlessly

## 5. Testing Strategy

### 5.1 Unit Tests

#### Backend Unit Tests
```php
// Tests/Unit/TriviaGameTest.php
class TriviaGameTest extends TestCase
{
    public function testGameNameGeneration()
    {
        // Test authenticated user
        $user = ModelFactory::new('Users');
        $user->set('first_name', 'John');
        $user->set('last_name', 'Doe');
        
        $game = ModelFactory::new('Movie_Quote_Trivia_Games');
        $game->generateGameName($user);
        
        $this->assertStringContains("John Doe's game played on", $game->get('name'));
        
        // Test guest user - created_by will be NULL
        $guestGame = ModelFactory::new('Movie_Quote_Trivia_Games');
        $guestGame->generateGameName(null);
        
        $this->assertStringContains("Guest game", $guestGame->get('name'));
        $this->assertMatchesRegularExpression('/Guest game \d{4}-\d{2}-\d{2} \d{2}:\d{2}/', $guestGame->get('name'));
        $this->assertNull($guestGame->get('created_by'));
    }
    
    public function testQuestionGeneration()
    {
        $game = ModelFactory::new('Movie_Quote_Trivia_Games');
        $questions = $game->generateQuestions(); // Uses Movie_Quote_Trivia_Question random selection
        
        $this->assertCount(15, $questions);
        $this->assertUniqueQuotes($questions);
    }
    
    public function testScoringSystem()
    {
        $game = ModelFactory::new('Movie_Quote_Trivia_Games');
        $game->set('score', 100);
        
        // Test correct answer with obscurity bonus
        $game->applyAnswerScore(true, 3, 5); // correct, obscurity 3, 5 seconds
        $this->assertEquals(95, $game->get('score')); // 100 - 5 (time) + 3 + 3 (bonus)
        
        // Test wrong answer
        $game->applyAnswerScore(false, 0, 3); // wrong, no obscurity, 3 seconds  
        $this->assertEquals(89, $game->get('score')); // 95 - 3 (time) - 3 (penalty)
    }
}
```

#### Frontend Unit Tests
```typescript
// src/components/trivia/__tests__/TriviaGameBoard.test.tsx
describe('TriviaGameBoard', () => {
  test('displays current question correctly', () => {
    const mockGame = createMockGame();
    render(<TriviaGameBoard game={mockGame} onAnswer={jest.fn()} />);
    
    expect(screen.getByText(mockGame.questions[0].quote)).toBeInTheDocument();
    expect(screen.getAllByRole('radio')).toHaveLength(3);
  });
  
  test('handles answer submission correctly', () => {
    const onAnswer = jest.fn();
    const mockGame = createMockGame();
    render(<TriviaGameBoard game={mockGame} onAnswer={onAnswer} />);
    
    fireEvent.click(screen.getByLabelText(/option 1/i));
    fireEvent.click(screen.getByText('Submit Answer'));
    
    expect(onAnswer).toHaveBeenCalledWith(0, 1); // question index, selected option
  });
  
  test('updates score display in real-time', () => {
    const mockGame = createMockGame();
    const { rerender } = render(<TriviaGameBoard game={mockGame} onAnswer={jest.fn()} />);
    
    expect(screen.getByText('100')).toBeInTheDocument();
    
    mockGame.score = 85;
    rerender(<TriviaGameBoard game={mockGame} onAnswer={jest.fn()} />);
    
    expect(screen.getByText('85')).toBeInTheDocument();
  });
});
```

### 5.2 Integration Tests

#### Backend Integration Tests
```php
// Tests/Integration/TriviaGameAPITest.php
class TriviaGameAPITest extends TestCase
{
    public function testStartGameEndpoint()
    {
        $response = $this->authenticatedPost('/trivia/start-game');
        
        $this->assertEquals(200, $response->getStatusCode());
        $data = json_decode($response->getContent(), true);
        
        $this->assertArrayHasKey('game_id', $data);
        $this->assertArrayHasKey('questions', $data);
        $this->assertCount(15, $data['questions']);
    }
    
    public function testSubmitAnswerEndpoint()
    {
        $game = $this->createTestGame();
        $question = $game->questions[0];
        
        $response = $this->authenticatedPost('/trivia/answer', [
            'game_id' => $game->get('id'),
            'question_id' => $question->get('id'),
            'selected_option' => 2,
            'time_taken' => 5
        ]);
        
        $this->assertEquals(200, $response->getStatusCode());
        $data = json_decode($response->getContent(), true);
        
        $this->assertArrayHasKey('correct', $data);
        $this->assertArrayHasKey('new_score', $data);
    }
}
```

### 5.3 User Acceptance Testing

#### Test Scenarios
1. **Complete Game Flow (Authenticated User)**
   - User starts new game
   - Answers all 15 questions
   - Receives final score
   - Score appears in high scores with user name

2. **Complete Game Flow (Guest User)**
   - Guest starts new game without login
   - Answers all 15 questions
   - Receives final score
   - Score appears in high scores as "Guest Player"

3. **Score Calculation Accuracy**
   - Verify time penalties apply correctly
   - Verify answer bonuses/penalties
   - Verify obscurity bonuses
   - Verify minimum score of 0

4. **Question Variety**
   - No duplicate quotes in single game (strict requirement)
   - Different incorrect options each game

5. **User Interface**
   - Responsive design on mobile/desktop
   - Smooth animations
   - Clear visual feedback
   - Touch-optimized controls on mobile
   - Single-session gameplay (no pause/resume)

## 6. Documentation

### 6.1 User Documentation

#### Game Rules Documentation
```markdown
# Movie Quote Trivia Game - How to Play

## Game Overview
Test your movie knowledge with 15 famous movie quotes! Can you identify which movie each quote is from?

## How to Play
1. Click "Start New Game" to begin
2. Read each movie quote carefully
3. Choose from 3 movie options by clicking a radio button
4. Click "Submit Answer" to proceed to the next question
5. Complete all 15 questions to finish the game

## Scoring System
- **Starting Score**: 100 points
- **Time Penalty**: -1 point per second of gameplay
- **Wrong Answer**: -3 points
- **Correct Answer**: +3 points + movie obscurity bonus (1-5 points)
- **Minimum Score**: 0 (score cannot go negative)

## High Scores
- Top 10 scores are displayed on the High Scores page (fixed limit)
- Games are ranked by final score
- Guest and authenticated user scores are treated equally
- View your personal game history in the Game History section (authenticated users only)
```

### 6.2 API Documentation

#### Trivia Game API Reference
```markdown
# Trivia Game API Endpoints

## POST /trivia/start-game
Start a new trivia game session.

**Response:**
```json
{
  "success": true,
  "data": {
    "game_id": "uuid",
    "score": 100,
    "questions": [
      {
        "id": "uuid",
        "quote": "Movie quote text",
        "options": [
          {
            "movie_id": "uuid",
            "name": "Movie Title (Year)",
            "poster_url": "https://..."
          }
        ],
        "order": 1
      }
    ]
  }
}
```

## PUT /trivia/answer
Submit an answer for a trivia question (updates the game record).

**Request Body:**
```json
{
  "game_id": "uuid",
  "question_id": "uuid", 
  "selected_option": 2,
  "time_taken": 5
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "correct": true,
    "new_score": 95,
    "correct_movie": "Correct Movie Title"
  }
}
```

## PUT /trivia/complete-game
Complete a trivia game session (updates the game with final results).

**Request Body:**
```json
{
  "game_id": "uuid"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "final_score": 95,
    "total_questions": 10,
    "correct_answers": 8,
    "game_completed": true,
    "rank": 5
  }
}
```
```

### 6.3 Developer Documentation

#### Adding New Question Types
```markdown
# Extending the Trivia Game System

## Adding New Question Types
The trivia system is designed to be extensible. To add new question types:

1. **Create Question Type Model**
   - Extend the base question structure
   - Define specific fields for the question type
   - Implement validation rules

2. **Update Question Generator**
   - Add logic to `TriviaGameAPIController::generateQuestions()`
   - Ensure proper randomization and balancing
   - Update scoring calculations if needed

3. **Frontend Components**
   - Create new question display components
   - Update answer option rendering
   - Maintain consistent user experience
```

## 7. Risks and Mitigations

### 7.1 Technical Risks

#### Risk: Poor Game Performance with Concurrent Users
**Impact**: High  
**Probability**: Medium  
**Mitigation**: 
- Implement database query optimization
- Add caching for frequently accessed movie data
- Use database connection pooling
- Load testing before production deployment

#### Risk: Frontend Animation Performance on Mobile
**Impact**: Medium  
**Probability**: Medium  
**Mitigation**: 
- Use CSS transforms instead of layout changes
- Implement requestAnimationFrame for smooth animations
- Optimize touch targets for mobile devices (48px for answer buttons, 44px for secondary controls)
- Test on various mobile devices and screen sizes
- Implement responsive design breakpoints

#### Risk: Question Generation Producing Unfair/Impossible Questions
**Impact**: High  
**Probability**: Low  
**Mitigation**: 
- Implement quality checks in question generation
- Ensure minimum diversity in movie options
- Add admin review tools for generated questions
- Implement question difficulty balancing

### 7.2 Data Risks

#### Risk: Insufficient Movie Quote Data for Variety
**Impact**: Medium  
**Probability**: Low  
**Mitigation**: 
- Current database has 89 quotes (sufficient for variety)
- Implement quote usage tracking to ensure rotation
- Add ability to import additional quotes
- Monitor quote repetition frequency

#### Risk: User Data Privacy in High Scores
**Impact**: Medium  
**Probability**: Low  
**Mitigation**: 
- Only display first name and last initial in public scores for authenticated users
- Display "Guest Player" for anonymous games
- Allow authenticated users to opt out of public leaderboards
- Implement data retention policies
- Ensure GDPR compliance for user data

### 7.3 User Experience Risks

#### Risk: Game Too Difficult for Casual Players
**Impact**: Medium  
**Probability**: Medium  
**Mitigation**: 
- Implement difficulty levels (easy/medium/hard)
- Add hint system for struggling players
- Provide practice mode without score tracking
- Gather user feedback for difficulty adjustments

#### Risk: Accessibility Issues for Users with Disabilities
**Impact**: Medium  
**Probability**: Medium  
**Mitigation**: 
- Implement keyboard navigation support
- Add screen reader compatibility
- Provide high contrast mode
- Include accessibility testing in QA process

## 8. Requirements Clarifications

### 8.1 Clarified Requirements

Based on stakeholder feedback, the following requirements have been clarified:

1. **User Authentication Requirements** ✅ **CLARIFIED**
   - **Decision**: Guest users CAN play without creating accounts
   - **Implementation**: 
     - Game accessible to both authenticated and guest users
     - Guest scores saved as "Guest Player" in high scores (created_by = NULL)
     - Optional login prompt for guests who want to save game history
     - Authenticated users get personalized game names and history tracking (created_by = User ID)
     - Player identity tracked via core `created_by` field from framework

2. **Game Session Persistence** ✅ **CLARIFIED**
   - **Decision**: NO pause and NO resume functionality
   - **Implementation**: 
     - Games must be completed in one continuous session
     - No save/load game state functionality
     - If user navigates away, game session is lost
     - Clear user messaging about single-session requirement

3. **Difficulty Levels** ✅ **CLARIFIED**
   - **Decision**: NO difficulty levels
   - **Implementation**: 
     - Single difficulty using existing movie obscurity scores
     - All players get the same challenge level
     - Obscurity scores provide natural difficulty variation within games

4. **Question Repetition Policy** ✅ **CLARIFIED**
   - **Decision**: No duplicate quotes within a single game session
   - **Implementation**: 
     - Algorithm ensures 15 unique quotes per game
     - No user history tracking across multiple games
     - Pure randomization between different game sessions
     - Validation to prevent duplicate quote selection

5. **Social Features** ✅ **CLARIFIED**
   - **Decision**: NO social features in initial implementation
   - **Implementation**: 
     - No score sharing on social media
     - No friend challenges or competitions
     - No multiplayer functionality
     - Focus on single-player experience

6. **Accessibility Requirements** ✅ **CLARIFIED**
   - **Decision**: NO specific accessibility requirements
   - **Implementation**: 
     - Standard web accessibility best practices
     - Semantic HTML structure
     - Proper color contrast
     - No specialized accessibility features required

7. **Mobile Optimization** ✅ **CLARIFIED**
   - **Decision**: NO offline play, YES touch optimization
   - **Implementation**: 
     - Requires internet connection for all functionality
     - Touch-optimized interface for mobile devices
     - Responsive design for various screen sizes
     - Minimum 44px touch targets
     - Mobile-friendly animations and interactions

### 8.2 Implementation Impact

These clarifications simplify the implementation significantly:

**Simplified Scope:**
- No user session persistence or pause/resume logic
- No difficulty level management
- No social sharing integration
- No offline functionality
- No specialized accessibility features

**Enhanced Guest Experience:**
- Public access increases user adoption
- Lower barrier to entry for casual players
- Simplified onboarding flow

**Mobile-First Design:**
- Touch-optimized interface design
- Responsive breakpoints for mobile/tablet/desktop
- Performance optimization for mobile networks

### 8.3 Finalized Design Decisions

The following implementation details have been finalized:

1. **Game Name Format for Guests** ✅ **FINALIZED**
   - **Decision**: "Guest game YYYY-MM-DD HH:MM"
   - **Implementation**: Use timestamp format for uniqueness and clarity
   - **Example**: "Guest game 2025-09-05 14:30"

2. **High Score Display Count** ✅ **FINALIZED**
   - **Decision**: Fixed limit of top 10 scores
   - **Implementation**: No expandable "Show More" option - keep interface simple
   - **Rationale**: Maintains focus on top performers and reduces complexity

3. **Mobile Touch Target Sizing** ✅ **FINALIZED**
   - **Decision**: 48px for answer buttons, 44px for secondary controls
   - **Implementation**: Primary game interaction buttons get larger touch areas
   - **Rationale**: Ensures accessibility while optimizing for primary user actions

4. **Score Persistence for Guests** ✅ **FINALIZED**
   - **Decision**: Treat guest scores same as authenticated user scores
   - **Implementation**: No discrimination in leaderboard rankings or data retention
   - **Rationale**: Encourages guest participation and maintains fairness

5. **Movie Quote Selection Method** ✅ **FINALIZED**
   - **Decision**: Leverage existing Movie_Quote_Trivia_Questions class auto-generation capabilities
   - **Implementation**: Use built-in question creation that automatically handles:
     - Random quote selection via `selectRandomMovieQuote()` method
     - Automatic distractor generation via `selectRandomDistractorMovies()` method  
     - Answer shuffling across 3 positions for fair distribution
     - Obscurity score integration for bonus calculations
   - **Rationale**: Existing class provides sophisticated question generation, reducing implementation complexity

### 8.4 Future Enhancement Opportunities

Features explicitly deferred for future releases:

1. **User Account Features**
   - Detailed game statistics and analytics
   - Personal achievement tracking
   - Custom avatar/profile customization

2. **Social and Multiplayer Features**
   - Real-time multiplayer competitions
   - Friend challenges and leaderboards
   - Social media score sharing

3. **Advanced Game Features**
   - Multiple difficulty levels
   - Custom question sets
   - Themed trivia categories
   - Timed speed rounds

4. **Accessibility Enhancements**
   - Screen reader optimization
   - Keyboard-only navigation
   - High contrast mode
   - Voice control support

5. **Mobile App Development**
   - Native iOS/Android applications
   - Offline mode with cached questions
   - Push notifications for challenges

---

## 📋 IMPLEMENTATION SUMMARY: Critical Metadata Discrepancies

### ⚠️ Schema Generation Note
**ALL database tables are automatically generated by the Gravitycar Framework's SchemaGenerator.** The SQL CREATE TABLE statements in this document are **REFERENCE ONLY** and should **NEVER be executed directly**. The SchemaGenerator reads model metadata files and creates the appropriate database structure.

### 🔍 Identified Metadata Discrepancies

**EXISTING Movie_Quote_Trivia_Questions metadata is NOT compatible with proposed trivia game system.**

#### Current State vs. Required State:

**MISSING CRITICAL FIELDS (specified for addition):**
- ✅ `game_id` - Links questions to game sessions (UUID, nullable, readOnly)
- ✅ `question_order` - Sequence tracking 1-15 (Integer, nullable, readOnly)  
- ✅ `user_selected_option` - Player answer recording (Integer 1-3, nullable)
- ✅ `answered_at` - Answer timestamp (DateTime, nullable)
- ✅ `time_taken_seconds` - Timing for scoring (Integer, nullable, min:0)

**IMPLEMENTATION APPROACH:**
- **BACKWARD COMPATIBLE**: New fields are nullable to support existing standalone questions
- **PRESERVE EXISTING**: All current fields and functionality maintained
- **EXTEND FUNCTIONALITY**: Adds game session support without breaking existing features

**CONFIRMED FIELD COMPATIBILITY:**
- ✅ `answer_option_1/2/3` (existing) matches proposed movie option storage
- ✅ `correct_answer` (existing) matches proposed answer tracking
- ✅ `answered_correctly` (existing) matches proposed validation
- ✅ `obscurity_score` (existing) supports bonus scoring

### 🛠️ Required Metadata Updates

1. **Movie_Quote_Trivia_Questions metadata** - ✅ **SPECIFIED**: Add 5 game session fields with exact definitions
2. **Movie_Quote_Trivia_Games metadata** - ✅ **SPECIFIED**: Create new metadata file with relationship reference
3. **Relationship definitions** - ✅ **SPECIFIED**: Create OneToMany relationship metadata file  
4. **UI field configurations** - ✅ **SPECIFIED**: Updated listFields and editFields for game management

### 📋 Implementation Approach

**CORE FIELDS UTILIZATION:**
- Player identity tracked using framework's core `created_by` field instead of custom `user_id` field
- `created_by_name` core field provides display name for authenticated users
- Guest users have `created_by = NULL`, authenticated users have `created_by = User ID`
- Eliminates redundancy and follows Gravitycar Framework conventions

**RELATIONSHIP ARCHITECTURE CORRECTED:**
- Relationships array contains only relationship names (strings), not definitions
- Actual relationship metadata stored in separate files following Gravitycar patterns
- Field-level references (RelatedRecord, ID fields) handle direct model associations
- OneToMany relationship file defines game-to-questions association

**BACKWARD COMPATIBILITY MAINTAINED:**
- All new fields are `nullable => true` to support existing standalone questions
- Existing field structure completely preserved  
- Current `create` and `edit` workflows continue to work
- New game session fields only populated when questions are part of trivia games

### ✅ Verified Schema Compatibility

After corrections, the proposed metadata **WILL generate the intended database schema** through the SchemaGenerator. All field names, data types, and constraints align between the metadata definitions and the reference SQL statements.

*This implementation plan provides a comprehensive roadmap for developing the Movie Quote Trivia Game within the Gravitycar Framework. The plan prioritizes core functionality while identifying areas for future enhancement and potential risks that require mitigation.*
